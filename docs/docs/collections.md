### ConcurrentHashMap 如何扩容

**扩容条件**：

1、元素总数大于阈值

2、某条链表长度大于8，但是数组长度小于64时候

3、调用 putAll 方法，但是容量不足以存下这么多元素

**多线程情况下的扩容**：

触发扩容条件后，new 一个长度为 2 倍长度的 table，把 sizectl 变量设置为 小于0 的一个基数，当前线程从老表的最后一个桶开始，把数据取出放入新表，每个线程最少负责 16 个桶的元素迁移，转移时锁住当前桶，转移完毕的桶节点变为一个 forward 节点。

新的线程如果进行 get、put 等操作的时候，如果发现这个桶是 forward 节点，那么就加入扩容。每个线程负责一部分桶的扩容，有一个 index 来标记扩容到了的地方，新来的线程就从这个 index 开始往后迁移数据，每个线程完成当前负责的迁移后继续申请往后扩容，直到所有的桶都迁移到新桶。

